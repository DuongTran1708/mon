#################
# SCALED-YOLOV4 #
#################
https://github.com/WongKinYiu/ScaledYOLOv4/tree/yolov4-large

################
# Installation #
################
sudo nvidia-docker run --name yolov4 -it \
-v "/mnt/workspace/mon/data/":/data/ \
-v "/mnt/workspace/mon/project/detpr/":/detpr \
--shm-size=64g nvcr.io/nvidia/pytorch:20.06-py3

sudo nvidia-docker run --name yolov4 -it \
-v "/home/longpham/workspace/mon/data/":/data/ \
-v "/home/longpham/workspace/mon/project/detpr/":/detpr \
--shm-size=64g nvcr.io/nvidia/pytorch:20.06-py3

cd /
git clone https://github.com/JunnYu/mish-cuda
cd mish-cuda
python setup.py build install

##################
# Initialization #
##################
cd /detpr/yolov4

#########
# Train #
#########
python -m torch.distributed.launch --nproc_per_node 2 train.py \
--weights "../run/train/yolov4-p7-visdrone-2160/weights/best.pt" \
--cfg "yolov4-p7.yaml" \
--data "a2i2-of.yaml" \
--epochs 10 \
--batch-size 8 \
--img 1536 \
--sync-bn \
--device 0,1 \
--name "yolov4-p7-visdrone-2160-a2i2-1536" \
--resume

########
# Test #
########
python test.py \
--weights "runs/stage12/yolov4-p7_visdrone_2160_a2i2haze_1536/weights/best_strip.pt" \
--data a2i2haze.yaml \
--batch-size 1 \
--img-size 2280 \
--conf-thres 0.001 \
--iou-thres 0.001 \
--device 0 \
--augment \
--merge

############
# Ensemble #
############
python ensemble.py

##########
# Detect #
##########
# 93.65
python detect.py \
--img-size 2160 \
--weights \
'runs/stage2/yolov4-p7_visdrone_2160_a2i2haze_1536/weights/best.pt' \
'runs/stage2/yolov4-p7_visdrone_2160_a2i2haze_1536_2/weights/best.pt' \
'runs/stage2/yolov4-p7_visdrone_2160_a2i2haze_1845/weights/best.pt' \
'runs/stage2/yolov4-p7_visdrone_2160_a2i2haze_1920/weights/best.pt' \
'runs/stage2/yolov4-p7_visdrone_2160_a2i2haze_2160/weights/best.pt' \
'runs/stage2/yolov4-p7_visdrone_2160_a2i2haze_2160_2/weights/best.pt' \
'runs/stage2/yolov4-p7_visdrone_2560_a2i2haze_1536/weights/best.pt' \
'runs/stage2/yolov4-p7_visdrone_2560_a2i2haze_2560/weights/best.pt' \
'runs/stage2/yolov4-p7_visdrone_uavdt_1536_a2i2haze_1536/weights/best.pt' \
--conf-thres 0.001 \
--iou-thres 0.001 \
--save-txt \
--agnostic-nms \
--augment
